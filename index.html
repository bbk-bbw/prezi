<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slide Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
        }
        .slide.active {
            display: flex;
        }
        /* Animation Styles */
        .fade-in-item {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .fade-in-item.visible {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-white">

    <div id="viewer" class="w-screen h-screen bg-white flex flex-col relative">
        <div id="slide-container" class="flex-grow p-8 md:p-16 flex items-center justify-center overflow-hidden">
            <div id="loading">
                <p class="text-xl text-gray-500">Loading slides...</p>
            </div>
        </div>
        <div class="absolute bottom-4 left-4 flex items-center z-10">
             <span id="slide-counter" class="text-sm text-gray-500 font-mono bg-black bg-opacity-20 px-2 py-1 rounded">0 / 0</span>
        </div>
        <div class="absolute bottom-4 right-4 flex items-center space-x-2 z-10">
            <button id="prev-btn" class="px-4 py-2 bg-gray-800 bg-opacity-50 text-white rounded-md hover:bg-opacity-75 transition-opacity disabled:opacity-20 disabled:cursor-not-allowed">Prev</button>
            <button id="next-btn" class="px-4 py-2 bg-gray-800 bg-opacity-50 text-white rounded-md hover:bg-opacity-75 transition-opacity disabled:opacity-20 disabled:cursor-not-allowed">Next</button>
        </div>
    </div>

    <script>
        // DOM elements
        const slideContainer = document.getElementById('slide-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const slideCounter = document.getElementById('slide-counter');
        const loadingIndicator = document.getElementById('loading');

        // State
        let slides = [];
        let templates = {};
        let currentSlideIndex = 0;
        let animationStep = 0;
        let animatableItems = [];

        // --- Core Functions ---

        function applyTemplate(template, slideData) {
            let output = template;
            for (const key in slideData) {
                const placeholder = `{{${key}}}`;
                if (output.includes(placeholder)) {
                    const value = slideData[key];
                    if (Array.isArray(value)) {
                        const listHtml = value.map(item => `<li>${item}</li>`).join('');
                        output = output.replace(new RegExp(placeholder, 'g'), listHtml);
                    } else if (typeof value === 'string' || typeof value === 'number') {
                        output = output.replace(new RegExp(placeholder, 'g'), value);
                    }
                }
            }
            return output;
        }

        function renderSlide() {
            if (slides.length === 0 || Object.keys(templates).length === 0) return;

            slideContainer.innerHTML = '';
            animationStep = 0;
            animatableItems = [];

            const slideData = slides[currentSlideIndex];
            const templateString = templates[slideData.type] || templates.default;
            const slideHtml = applyTemplate(templateString, slideData);

            const slideElement = document.createElement('div');
            slideElement.className = 'slide active w-full h-full flex items-center justify-center';
            slideElement.innerHTML = slideHtml;
            
            const containersToAnimate = slideElement.querySelectorAll('.animate-children');
            containersToAnimate.forEach(container => {
                const children = Array.from(container.children);
                children.forEach(child => {
                    child.classList.add('fade-in-item');
                    animatableItems.push(child);
                });
            });

            slideContainer.appendChild(slideElement);
            updateControls();
        }

        function updateControls() {
            slideCounter.textContent = `${currentSlideIndex + 1} / ${slides.length}`;
            prevBtn.disabled = currentSlideIndex === 0 && animationStep === 0;
            const isLastSlide = currentSlideIndex === slides.length - 1;
            const isLastStep = animationStep === animatableItems.length;
            nextBtn.disabled = isLastSlide && isLastStep;
        }

        function nextStep() {
            if (animationStep < animatableItems.length) {
                animatableItems[animationStep].classList.add('visible');
                animationStep++;
            } else {
                if (currentSlideIndex < slides.length - 1) {
                    currentSlideIndex++;
                    renderSlide();
                }
            }
            updateControls();
        }

        function prevStep() {
            if (animationStep > 0) {
                animationStep--;
                animatableItems[animationStep].classList.remove('visible');
            } else {
                if (currentSlideIndex > 0) {
                    currentSlideIndex--;
                    renderSlide();
                }
            }
            updateControls();
        }

        async function initializeViewer(fileId) {
            const slideUrl = `./json/${fileId}.json`;
            const templateUrl = './templates.json';

            try {
                const [slideResponse, templateResponse] = await Promise.all([
                    fetch(slideUrl),
                    fetch(templateUrl)
                ]);

                if (!slideResponse.ok) throw new Error(`Failed to load slides: ${slideResponse.statusText}`);
                if (!templateResponse.ok) throw new Error(`Failed to load templates: ${templateResponse.statusText}`);

                const slideData = await slideResponse.json();
                templates = await templateResponse.json();

                slides = slideData.slides;
                loadingIndicator.style.display = 'none';

                if (slides && slides.length > 0) {
                    currentSlideIndex = 0;
                    renderSlide();
                } else {
                    slideContainer.innerHTML = '<p class="text-red-500">No slides found in the JSON file.</p>';
                }

            } catch (error) {
                console.error("Failed to initialize viewer:", error);
                loadingIndicator.style.display = 'none';
                slideContainer.innerHTML = `<p class="text-red-500">Error loading content. Check file paths and JSON format.</p>`;
            }
        }

        // --- Event Listeners ---
        nextBtn.addEventListener('click', nextStep);
        prevBtn.addEventListener('click', prevStep);
        
        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowRight') {
                nextBtn.click();
            } else if (event.key === 'ArrowLeft') {
                prevBtn.click();
            }
        });

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const fileId = params.get('id');

            if (fileId) {
                initializeViewer(fileId);
            } else {
                 loadingIndicator.style.display = 'none';
                 slideContainer.innerHTML = '<p class="text-gray-500">Please provide a file name via the "id" query parameter.</p>';
                 prevBtn.disabled = true;
                 nextBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
