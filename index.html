<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slide Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .slide.active {
            display: flex;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">

    <div id="viewer" class="w-full max-w-4xl aspect-[16/9] bg-white rounded-lg shadow-lg flex flex-col relative">
        <div id="slide-container" class="flex-grow p-8 md:p-16 flex items-center justify-center overflow-hidden">
            <div id="loading">
                <p class="text-xl text-gray-500">Loading slides...</p>
            </div>
        </div>
        <div class="absolute bottom-4 left-4 flex items-center">
             <span id="slide-counter" class="text-sm text-gray-500 font-mono">0 / 0</span>
        </div>
        <div class="absolute bottom-4 right-4 flex items-center space-x-2">
            <button id="prev-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
            <button id="next-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
        </div>
    </div>

    <div class="mt-4 text-sm text-gray-500 text-center">
        <p>To use: `?id=[your_json_filename_without_extension]`</p>
        <p>Example: `.../index.html?id=test` will fetch `./json/test.json`</p>
    </div>

    <script>
        // DOM elements
        const slideContainer = document.getElementById('slide-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const slideCounter = document.getElementById('slide-counter');
        const loadingIndicator = document.getElementById('loading');

        // State
        let slides = [];
        let templates = {};
        let currentSlideIndex = 0;

        // --- Core Functions ---

        /**
         * Replaces placeholders in a template string with data from a slide object.
         * This version is more generic and can handle any array to format it as list items.
         * @param {string} template - The HTML template string with {{placeholders}}.
         * @param {object} slideData - The data object for the slide.
         * @returns {string} - The populated HTML string.
         */
        function applyTemplate(template, slideData) {
            let output = template;
            // Handle all key-value replacements, with special handling for arrays.
            for (const key in slideData) {
                const placeholder = `{{${key}}}`;
                if (output.includes(placeholder)) {
                    const value = slideData[key];
                    if (Array.isArray(value)) {
                        // If the value is an array of strings, format it as list items.
                        const listHtml = value.map(item => `<li>${item}</li>`).join('');
                        output = output.replace(new RegExp(placeholder, 'g'), listHtml);
                    } else {
                        // Otherwise, do a simple string replacement for primitive values.
                        if(typeof value === 'string' || typeof value === 'number') {
                           output = output.replace(new RegExp(placeholder, 'g'), value);
                        }
                    }
                }
            }
            return output;
        }

        /**
         * Renders the current slide based on its index.
         */
        function renderSlide() {
            if (slides.length === 0 || Object.keys(templates).length === 0) return;

            slideContainer.innerHTML = '';

            const slideData = slides[currentSlideIndex];
            const templateString = templates[slideData.type] || templates.default;
            const slideHtml = applyTemplate(templateString, slideData);

            const slideElement = document.createElement('div');
            slideElement.className = 'slide active w-full h-full flex items-center justify-center';
            slideElement.innerHTML = slideHtml;

            slideContainer.appendChild(slideElement);

            updateControls();
        }

        /**
         * Updates the state of the navigation buttons and counter.
         */
        function updateControls() {
            slideCounter.textContent = `${currentSlideIndex + 1} / ${slides.length}`;
            prevBtn.disabled = currentSlideIndex === 0;
            nextBtn.disabled = currentSlideIndex === slides.length - 1;
        }

        /**
         * Fetches and initializes the slides and templates.
         */
        async function initializeViewer(fileId) {
            const slideUrl = `./json/${fileId}.json`;
            const templateUrl = './templates.json';

            try {
                // Fetch both files concurrently
                const [slideResponse, templateResponse] = await Promise.all([
                    fetch(slideUrl),
                    fetch(templateUrl)
                ]);

                if (!slideResponse.ok) throw new Error(`Failed to load slides: ${slideResponse.statusText}`);
                if (!templateResponse.ok) throw new Error(`Failed to load templates: ${templateResponse.statusText}`);

                const slideData = await slideResponse.json();
                templates = await templateResponse.json(); // Store templates globally

                slides = slideData.slides;
                loadingIndicator.style.display = 'none';

                if (slides && slides.length > 0) {
                    currentSlideIndex = 0;
                    renderSlide();
                } else {
                    slideContainer.innerHTML = '<p class="text-red-500">No slides found in the JSON file.</p>';
                }

            } catch (error) {
                console.error("Failed to initialize viewer:", error);
                loadingIndicator.style.display = 'none';
                slideContainer.innerHTML = `<p class="text-red-500">Error loading content. Check file paths and JSON format.</p>`;
            }
        }

        // --- Event Listeners ---
        nextBtn.addEventListener('click', () => {
            if (currentSlideIndex < slides.length - 1) {
                currentSlideIndex++;
                renderSlide();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                renderSlide();
            }
        });

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const fileId = params.get('id');

            if (fileId) {
                initializeViewer(fileId);
            } else {
                 loadingIndicator.style.display = 'none';
                 slideContainer.innerHTML = '<p class="text-gray-500">Please provide a file name via the "id" query parameter.</p>';
                 prevBtn.disabled = true;
                 nextBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
